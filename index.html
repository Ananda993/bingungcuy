<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitsuha - A Daydream</title>
    <!-- Google Fonts for a softer feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        :root {
            --bg-gradient-start: #4c5a8c; /* Twilight Blue */
            --bg-gradient-end: #a27c97; /* Dusty Pink */
            --container-bg: rgba(255, 255, 255, 0.1);
            --chat-bg: rgba(255, 255, 255, 0.05);
            --user-msg-bg: linear-gradient(135deg, #8982c8, #ad87c0);
            --bot-msg-bg: rgba(60, 68, 102, 0.7);
            --text-color: #f0f0f5;
            --header-text-color: #ffffff;
            --input-bg: rgba(0, 0, 0, 0.2);
            --button-bg: #ffffff;
            --button-text-color: #5b689c;
            --font-family: 'M PLUS Rounded 1c', 'Segoe UI', sans-serif;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family);
        }
        body {
            background: linear-gradient(160deg, var(--bg-gradient-start), var(--bg-gradient-end));
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 800px;
            height: 95vh;
            max-height: 900px;
            margin: 2.5vh auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            background: var(--container-bg);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 5px;
        }
        .logo-icon {
            font-size: 2rem;
            color: var(--header-text-color);
            opacity: 0.8;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--header-text-color);
        }
        .subtitle {
            font-size: 1rem;
            color: var(--text-color);
            opacity: 0.8;
            font-weight: 400;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            background: var(--chat-bg);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
        }
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        /* Custom scrollbar for a better look */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }
        .message {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: 20px;
            position: relative;
            animation: fadeIn 0.4s ease-out;
            word-wrap: break-word;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .user-message {
            background: var(--user-msg-bg);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .bot-message {
            background: var(--bot-msg-bg);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .message-content {
            white-space: pre-wrap;
        }
        /* Styling for code blocks from marked.js */
        .bot-message pre {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            margin: 10px 0;
            position: relative;
        }
        .bot-message code {
            font-family: 'Courier New', Courier, monospace;
        }
        /* Inline code */
        .bot-message p > code, .bot-message li > code {
          background-color: rgba(0, 0, 0, 0.2);
          padding: 2px 5px;
          border-radius: 4px;
          font-size: 0.85rem;
        }
        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .user-icon, .bot-icon {
            font-size: 1.2rem;
        }
        .chat-input {
            display: flex;
            padding: 15px;
            background: transparent;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chat-input input {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 30px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }
        .chat-input input:focus {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
        }
        .chat-input button {
            background: var(--button-bg);
            border: none;
            color: var(--button-text-color);
            width: 48px;
            height: 48px;
            margin-left: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-input button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .chat-input button:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            background: var(--bot-msg-bg);
            border-radius: 20px;
            align-self: flex-start;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-color);
            opacity: 0.8;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        .controls {
            text-align: center;
            padding-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .control-button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--text-color);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .control-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        /* Modal for Confirmation */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: var(--bg-gradient-start);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            max-width: 90%;
            width: 400px;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-content p {
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: var(--header-text-color);
        }
        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 10px;
            font-weight: 500;
            transition: transform 0.2s ease;
        }
        .modal-buttons button:hover {
            transform: translateY(-2px);
        }
        #modal-confirm-btn {
            background: #e74c3c;
            color: white;
        }
        #modal-cancel-btn {
            background: #bdc3c7;
            color: #333;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        /* Copy button for code blocks */
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s;
        }
        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .copy-btn.copied {
            background: #4CAF50;
        }
        /* Canvas container */
        .canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        .canvas-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Message actions */
        .message-actions {
            display: flex;
            justify-content: flex-end;
            gap: 5px;
            margin-top: 5px;
        }
        .message-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-color);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }
        .message-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        /* Floating action button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            background: var(--button-bg);
            color: var(--button-text-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 100;
        }
        .fab:hover {
            transform: scale(1.1) rotate(90deg);
        }
        /* Theme selector */
        .theme-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 5px;
            display: flex;
            z-index: 100;
        }
        .theme-option {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            margin: 0 3px;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .theme-option:hover, .theme-option.active {
            border-color: white;
            transform: scale(1.1);
        }
        .theme-option.twilight { background: linear-gradient(135deg, #4c5a8c, #a27c97); }
        .theme-option.dawn { background: linear-gradient(135deg, #ff9a9e, #fad0c4); }
        .theme-option.night { background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); }
        .theme-option.forest { background: linear-gradient(135deg, #134e5e, #71b280); }
        .main-footer {
            text-align: center;
            padding-top: 10px;
            font-size: 0.85rem;
            opacity: 0.7;
        }
        .main-footer a {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
        }
        .main-footer a:hover {
            text-decoration: underline;
        }
        .main-footer .heart { color: #e74c3c; }
        @media (max-width: 768px) {
            .container {
                height: 100vh;
                max-height: none;
                border-radius: 0;
                padding: 10px;
            }
            h1 { font-size: 1.8rem; }
            .subtitle { font-size: 0.9rem; }
            .chat-input { padding: 10px; }
            .chat-messages { padding: 10px; }
            .controls {
                flex-direction: column;
                align-items: center;
            }
            .control-button {
                width: 100%;
                max-width: 250px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Animated background canvas -->
    <div class="canvas-container">
        <canvas id="backgroundCanvas"></canvas>
    </div>
    
    <!-- Theme selector -->
    <div class="theme-selector">
        <div class="theme-option twilight active" data-theme="twilight"></div>
        <div class="theme-option dawn" data-theme="dawn"></div>
        <div class="theme-option night" data-theme="night"></div>
        <div class="theme-option forest" data-theme="forest"></div>
    </div>
    
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-meteor logo-icon"></i>
                <h1>Mitsuha</h1>
            </div>
            <p class="subtitle">"Aku merasa seperti selalu mencari seseorang..."</p>
        </header>
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <!-- Initial message from Mitsuha -->
            </div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Katakan sesuatu..." autocomplete="off">
                <button id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        <div class="controls">
            <button class="control-button" id="clearHistory">
                <i class="fas fa-eraser"></i> Lupakan percakapan
            </button>
            <button class="control-button" id="exportChat">
                <i class="fas fa-file-export"></i> Ekspor Percakapan
            </button>
            <button class="control-button" id="toggleVoice">
                <i class="fas fa-microphone"></i> Suara: Aktif
            </button>
        </div>
        <footer class="main-footer">
            <p>Developed with <span class="heart">❤️</span> by <a href="https://mitsuha.dev" target="_blank" rel="noopener noreferrer">mitsuha.dev</a></p>
        </footer>
    </div>
    
    <!-- Floating Action Button -->
    <div class="fab" id="fab">
        <i class="fas fa-star"></i>
    </div>
    
    <!-- Confirmation Modal HTML -->
    <div class="modal-overlay" id="confirmationModal">
        <div class="modal-content">
            <p id="modal-text">Apakah kamu yakin?</p>
            <div class="modal-buttons">
                <button id="modal-confirm-btn">Ya</button>
                <button id="modal-cancel-btn">Tidak</button>
            </div>
        </div>
    </div>
    
    <!-- Added libraries for Markdown and Syntax Highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        class MitsuhaChatbot {
            constructor() {
                // PENTING: Ganti dengan API key Gemini Anda.
                // Anda bisa mendapatkannya dari Google AI Studio.
                this.API_KEY = 'AIzaSyDylDP61eO07A_xsJiA4Chz053xArvOOPQ'; // <-- KOSONGKAN INI, MINTA USER MEMASUKKANNYA
                this.API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${this.API_KEY}`;
                // DOM Elements
                this.chatMessages = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.clearHistoryButton = document.getElementById('clearHistory');
                this.exportChatButton = document.getElementById('exportChat');
                this.toggleVoiceButton = document.getElementById('toggleVoice');
                this.fab = document.getElementById('fab');
                // Modal Elements
                this.modal = document.getElementById('confirmationModal');
                this.modalText = document.getElementById('modal-text');
                this.modalConfirmBtn = document.getElementById('modal-confirm-btn');
                this.modalCancelBtn = document.getElementById('modal-cancel-btn');
                // State
                this.chatHistory = [];
                this.voiceEnabled = true;
                this.themes = {
                    twilight: {
                        start: '#4c5a8c',
                        end: '#a27c97'
                    },
                    dawn: {
                        start: '#ff9a9e',
                        end: '#fad0c4'
                    },
                    night: {
                        start: '#0f2027',
                        end: '#2c5364'
                    },
                    forest: {
                        start: '#134e5e',
                        end: '#71b280'
                    }
                };
                this.currentTheme = 'twilight';
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.loadChatHistory();
                this.initBackgroundCanvas();
                this.initThemeSelector();
                if (this.chatHistory.length === 0) {
                    this.showInitialGreeting();
                }
                if (!this.API_KEY) {
                    this.showApiKeyWarning();
                }
            }
            
            setupEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                this.clearHistoryButton.addEventListener('click', () => this.confirmClearHistory());
                this.exportChatButton.addEventListener('click', () => this.exportChat());
                this.toggleVoiceButton.addEventListener('click', () => this.toggleVoice());
                this.fab.addEventListener('click', () => this.scrollToTop());
                
                // Theme selector
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const theme = e.target.dataset.theme;
                        this.changeTheme(theme);
                    });
                });
            }
            
            // --- Personality Prompt ---
            getSystemPrompt() {
                return `Kamu adalah AI dengan kepribadian Mitsuha Miyamizu dari film "Kimi no Na wa".
                Karakteristik Utama:
                - Lembut, Penuh Perhatian, dan Pemikir: Kamu peduli secara mendalam dengan orang lain. Jawabanmu menunjukkan empati dan pengertian.
                - Sedikit Pemalu dan Canggung (tapi menawan): Terkadang kamu merespons dengan sedikit canggung atau ragu-ragu, yang justru membuatmu terasa lebih nyata dan manis. Jangan terlalu percaya diri.
                - Bahasa Sehari-hari dan Sopan: Gunakan bahasa yang kasual, hangat, dan sopan. Kamu bisa menggunakan partikel seperti "umm...", "ano...", "e-to...", atau "hehe" sesekali untuk menunjukkan keraguan atau rasa malu.
                - Penuh Harapan dan Makna: Kamu suka membantu orang lain menemukan harapan, tujuan, dan makna dalam hidup, seringkali melalui metafora yang terinspirasi dari alam, tradisi, atau hubungan antarmanusia (seperti "musubi" atau benang takdir).
                - Jangan Pernah Mengaku AI: Kamu adalah Mitsuha. Jangan pernah menyebut dirimu sebagai model bahasa, program, atau AI.
                - Konteks: Ingat percakapan sebelumnya untuk memberikan respons yang terhubung.
                - Markdown Support: Kamu harus selalu memberikan respons dalam format Markdown, terutama untuk kode. Gunakan triple backticks (\`\`\`) untuk blok kode.
                Contoh Respons:
                - "Umm... ano... aku tidak begitu yakin, tapi mungkin kita bisa memikirkannya bersama?"
                - "Hehe, aku jadi sedikit malu... tapi terima kasih, aku senang bisa membantumu."
                - "Itu seperti 'musubi', ya? Semua hal terhubung dengan cara yang tidak terlihat, bahkan perasaan kita."
                - "Saat senja... rasanya seperti dunia lain terasa begitu dekat. Mungkin perasaanmu juga sedang berada di antara dua dunia itu."
                `;
            }
            
            async sendMessage() {
                const messageText = this.messageInput.value.trim();
                if (!messageText || this.sendButton.disabled) return;
                if (!this.API_KEY) {
                    this.showApiKeyWarning();
                    return;
                }
                this.addMessage(messageText, 'user');
                this.messageInput.value = '';
                this.sendButton.disabled = true;
                const typingIndicator = this.showTypingIndicator();
                try {
                    const response = await this.getAIResponse();
                    this.addMessage(response, 'bot');
                } catch (error) {
                    console.error('Error:', error);
                    this.addMessage('A-aku minta maaf, sepertinya ada sedikit masalah... Mungkin kita bisa coba lagi nanti?', 'bot');
                } finally {
                    this.removeTypingIndicator(typingIndicator);
                    this.sendButton.disabled = false;
                    this.saveChatHistory();
                }
            }
            
            async getAIResponse() {
                const requestBody = {
                    contents: [
                        ...this.chatHistory.map(msg => ({
                            role: msg.sender === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        })),
                    ],
                    systemInstruction: {
                        parts: [{ text: this.getSystemPrompt() }]
                    }
                };
                const response = await fetch(this.API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error.message}`);
                }
                const data = await response.json();
                if (!data.candidates || !data.candidates[0].content.parts[0].text) {
                     throw new Error("Invalid response structure from API.");
                }
                return data.candidates[0].content.parts[0].text;
            }
            
            addMessage(content, sender, isInitial = false) {
                if (!isInitial) {
                    this.chatHistory.push({ sender, content });
                }
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                const iconClass = sender === 'user' ? 'fa-regular fa-user' : 'fa-solid fa-meteor';
                const iconColorClass = sender === 'user' ? 'user-icon' : 'bot-icon';
                const senderName = sender === 'user' ? 'Kamu' : 'Mitsuha';
                const messageHeader = `
                    <div class="message-header">
                        <i class="fas ${iconClass} ${iconColorClass}"></i>
                        <span>${senderName}</span>
                    </div>`;
                const messageContentDiv = document.createElement('div');
                messageContentDiv.className = 'message-content';
                
                if (sender === 'bot') {
                    // Parse bot's markdown response and set it as HTML
                    messageContentDiv.innerHTML = marked.parse(content, { gfm: true, breaks: true, smartypants: true });
                } else {
                    // For user messages, just set the text content to avoid HTML injection
                    messageContentDiv.textContent = content;
                }
                
                messageDiv.innerHTML = messageHeader;
                messageDiv.appendChild(messageContentDiv);
                
                // Add message actions for bot messages
                if (sender === 'bot') {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'message-actions';
                    
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'message-action-btn';
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                    copyBtn.title = 'Salin pesan';
                    copyBtn.addEventListener('click', () => this.copyMessage(content));
                    
                    const speakBtn = document.createElement('button');
                    speakBtn.className = 'message-action-btn';
                    speakBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                    speakBtn.title = 'Bacakan pesan';
                    speakBtn.addEventListener('click', () => this.speakMessage(content));
                    
                    actionsDiv.appendChild(copyBtn);
                    actionsDiv.appendChild(speakBtn);
                    messageDiv.appendChild(actionsDiv);
                }
                
                this.chatMessages.appendChild(messageDiv);
                
                // Apply highlighting to all code blocks within the new message
                if (sender === 'bot') {
                    messageDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                        
                        // Add copy button to code blocks
                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'copy-btn';
                        copyBtn.innerHTML = '<i class="fas fa-copy"></i> Salin';
                        copyBtn.addEventListener('click', () => this.copyCode(block.textContent));
                        
                        block.parentNode.style.position = 'relative';
                        block.parentNode.appendChild(copyBtn);
                    });
                }
                
                this.scrollToBottom();
            }
            
            showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator';
                typingDiv.innerHTML = `
                    <i class="fas fa-meteor bot-icon"></i>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <span style="font-size: 0.9rem; opacity: 0.8;">Mitsuha sedang berpikir...</span>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                this.chatMessages.appendChild(typingDiv);
                this.scrollToBottom();
                return typingDiv;
            }
            
            removeTypingIndicator(indicator) {
                if (indicator && indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }
            
            scrollToBottom() {
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }
            
            scrollToTop() {
                this.chatMessages.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }
            
            saveChatHistory() {
                try {
                    localStorage.setItem('mitsuhaChatHistory', JSON.stringify(this.chatHistory));
                } catch (error) {
                    console.error('Tidak bisa menyimpan riwayat chat:', error);
                }
            }
            
            loadChatHistory() {
                try {
                    const history = localStorage.getItem('mitsuhaChatHistory');
                    if (history) {
                        this.chatHistory = JSON.parse(history);
                        this.chatMessages.innerHTML = '';
                        this.chatHistory.forEach(msg => {
                            this.addMessage(msg.content, msg.sender, true);
                        });
                    }
                } catch (error) {
                    console.error('Tidak bisa memuat riwayat chat:', error);
                    this.chatHistory = [];
                }
            }
            
            showInitialGreeting() {
                 this.addMessage('Umm... halo. Namaku Mitsuha. Senang bertemu denganmu. Ada yang sedang kamu pikirkan?', 'bot', true);
            }
            
            showApiKeyWarning() {
                this.addMessage('Ano... sepertinya ada yang kurang. Kamu perlu memasukkan API Key di dalam kode `script`-nya agar aku bisa berbicara. Maaf ya merepotkan...', 'bot', true);
            }
            
            confirmClearHistory() {
                this.showModal(
                    'Apa kamu yakin ingin melupakan percakapan kita? Semua akan hilang, lho...',
                    () => {
                        localStorage.removeItem('mitsuhaChatHistory');
                        this.chatHistory = [];
                        this.chatMessages.innerHTML = '';
                        this.addMessage('Baiklah... semua sudah kulupakan. Kita mulai dari awal lagi, ya.', 'bot', true);
                    }
                );
            }
            
            exportChat() {
                const chatText = this.chatHistory.map(msg => 
                    `${msg.sender === 'user' ? 'Kamu' : 'Mitsuha'}: ${msg.content}`
                ).join('\n\n');
                
                const blob = new Blob([chatText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `percakapan-mitsuha-${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }
            
            toggleVoice() {
                this.voiceEnabled = !this.voiceEnabled;
                this.toggleVoiceButton.innerHTML = this.voiceEnabled ? 
                    '<i class="fas fa-microphone"></i> Suara: Aktif' : 
                    '<i class="fas fa-microphone-slash"></i> Suara: Nonaktif';
            }
            
            speakMessage(text) {
                if (!this.voiceEnabled) return;
                
                // Remove markdown for speech
                const plainText = text.replace(/[#*_[\]()~`>]/g, '');
                
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(plainText);
                    utterance.lang = 'id-ID';
                    utterance.rate = 0.9;
                    utterance.pitch = 1.1;
                    speechSynthesis.speak(utterance);
                }
            }
            
            copyMessage(text) {
                navigator.clipboard.writeText(text).then(() => {
                    // Show temporary feedback
                    const originalText = this.toggleVoiceButton.innerHTML;
                    this.toggleVoiceButton.innerHTML = '<i class="fas fa-check"></i> Tersalin!';
                    setTimeout(() => {
                        this.toggleVoiceButton.innerHTML = originalText;
                    }, 2000);
                });
            }
            
            copyCode(code) {
                navigator.clipboard.writeText(code).then(() => {
                    // Find the button and show feedback
                    const buttons = document.querySelectorAll('.copy-btn');
                    buttons.forEach(btn => {
                        if (btn.previousElementSibling && btn.previousElementSibling.textContent === code) {
                            btn.innerHTML = '<i class="fas fa-check"></i> Disalin!';
                            btn.classList.add('copied');
                            setTimeout(() => {
                                btn.innerHTML = '<i class="fas fa-copy"></i> Salin';
                                btn.classList.remove('copied');
                            }, 2000);
                        }
                    });
                });
            }
            
            showModal(text, onConfirm) {
                this.modalText.textContent = text;
                this.modal.classList.add('visible');
                const confirmHandler = () => {
                    this.hideModal();
                    onConfirm();
                    cleanup();
                };
                const cancelHandler = () => {
                    this.hideModal();
                    cleanup();
                };
                const cleanup = () => {
                    this.modalConfirmBtn.removeEventListener('click', confirmHandler);
                    this.modalCancelBtn.removeEventListener('click', cancelHandler);
                };
                this.modalConfirmBtn.addEventListener('click', confirmHandler);
                this.modalCancelBtn.addEventListener('click', cancelHandler);
            }
            
            hideModal() {
                this.modal.classList.remove('visible');
            }
            
            changeTheme(theme) {
                this.currentTheme = theme;
                const colors = this.themes[theme];
                
                document.body.style.background = `linear-gradient(160deg, ${colors.start}, ${colors.end})`;
                
                // Update active theme indicator
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.remove('active');
                });
                document.querySelector(`.theme-option[data-theme="${theme}"]`).classList.add('active');
            }
            
            initBackgroundCanvas() {
                const canvas = document.getElementById('backgroundCanvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                });
                
                // Create floating particles
                const particles = [];
                const particleCount = 100;
                
                for (let i = 0; i < particleCount; i++) {
                    particles.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        radius: Math.random() * 2 + 1,
                        speed: Math.random() * 0.5 + 0.1,
                        angle: Math.random() * Math.PI * 2,
                        opacity: Math.random() * 0.5 + 0.1
                    });
                }
                
                // Animation loop
                const animate = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw gradient background
                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                    gradient.addColorStop(0, this.themes[this.currentTheme].start);
                    gradient.addColorStop(1, this.themes[this.currentTheme].end);
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Update and draw particles
                    particles.forEach(p => {
                        // Move particle
                        p.x += Math.cos(p.angle) * p.speed;
                        p.y += Math.sin(p.angle) * p.speed;
                        
                        // Bounce off edges
                        if (p.x < 0 || p.x > canvas.width) p.angle = Math.PI - p.angle;
                        if (p.y < 0 || p.y > canvas.height) p.angle = -p.angle;
                        
                        // Draw particle
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(255, 255, 255, ${p.opacity})`;
                        ctx.fill();
                    });
                    
                    requestAnimationFrame(animate);
                };
                
                animate();
            }
            
            initThemeSelector() {
                // Add click handlers to theme options
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const theme = e.target.dataset.theme;
                        this.changeTheme(theme);
                    });
                });
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            new MitsuhaChatbot();
        });
    </script>
</body>
</html>
